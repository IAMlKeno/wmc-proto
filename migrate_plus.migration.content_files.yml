uuid: b563cb1f-9d57-4d17-b2aa-68eab2846e22
langcode: en
status: true
dependencies:
  enforced:
    module:
      - dgi_migrate
_core:
  default_config_hash: frjvLO_bToQmJ8lQxVg1_ymzMhUBq1zCiQusdBZXd5c
id: content_files
class: null
field_plugin_method: null
cck_plugin_method: null
migration_tags: null
migration_group: foxml_to_nodes
label: 'Content from FOXML into file entities'
source:
  plugin: dgi_migrate.source.migration
  track_changes: true
  migration: foxml_files
  constants:
    file_dest: 'repo-bin:/'
process:
  _noded:
    -
      plugin: migration_lookup
      source: fid
      migration: foxml_nodes
      no_stub: true
    -
      plugin: skip_on_empty
      method: row
  _parsed:
    -
      plugin: dgi_migrate.load_entity
      source: fid
      entity_type: 'entity:file'
    -
      plugin: dgi_migrate.method
      method: getFileUri
    -
      plugin: dgi_migrate.parse_foxml
  _models:
    -
      plugin: dgi_migrate.method
      source: '@_parsed'
      method: models
    -
      plugin: skip_on_empty
      method: row
  _source_dsid:
    -
      plugin: static_map
      source: '@_models'
      bypass: false
      map:
        'info:fedora/islandora:sp_basic_image': OBJ
        'info:fedora/islandora:sp_large_image_cmodel': OBJ
        'info:fedora/ir:citationCModel': PDF
        'info:fedora/islandora:sp_pdf': OBJ
        'info:fedora/islandora:sp_videoCModel': OBJ
        'info:fedora/islandora:sp-audioCModel': OBJ
        'info:fedora/islandora:binaryObjectCModel': OBJ
    -
      plugin: extract
      index:
        - 0
  _latest:
    -
      plugin: dgi_migrate.subindex
      source: '@_parsed'
      index_from_destination: _source_dsid
      skip_row_if_missing: true
    -
      plugin: dgi_migrate.method
      method: latest
  created:
    -
      plugin: dgi_migrate.subproperty
      source: '@_latest'
      property: CREATED
    -
      plugin: callback
      callable: strtotime
  _source_uri:
    -
      plugin: dgi_migrate.method
      source: '@_latest'
      method: getUri
  _path:
    -
      plugin: format_date
      source: '@created'
      from_format: U
      to_format: Y-m
  filemime:
    -
      plugin: dgi_migrate.subproperty
      property: MIMETYPE
      source: '@_latest'
  _ext:
    plugin: dgi_migrate.process.extension_from_mimetype
    source: '@filemime'
  _safe_pid:
    -
      plugin: dgi_migrate.subproperty
      source: '@_parsed'
      property: PID
    -
      plugin: machine_name
  filename:
    -
      plugin: concat
      source:
        - '@_safe_pid'
        - '@_ext'
      delimiter: .
  _dest_uri:
    -
      plugin: concat
      source:
        - constants/file_dest
        - '@_path'
        - '@filename'
      delimiter: /
  uri:
    -
      plugin: dgi_migrate.naive_file_copy
      file_exists: rename
      source:
        - '@_source_uri'
        - '@_dest_uri'
  filesize:
    -
      plugin: callback
      source: '@uri'
      callable: filesize
  status:
    -
      plugin: default_value
      default_value: 1
  uid:
    -
      plugin: default_value
      source: shared/default_uid
      default_value: 0
destination:
  plugin: 'entity:file'
  validate: true
migration_dependencies:
  required:
    - foxml_nodes
    - foxml_files
